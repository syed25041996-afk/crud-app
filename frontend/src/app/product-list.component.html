<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Product Management</h1>
    <button class="btn btn-primary" (click)="onAddNew()">Add New Product</button>
  </div>

  @if (loading) {
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  } @else if (error) {
    <div class="alert alert-danger" role="alert">
      {{ error }}
    </div>
  } @else if (products.length === 0) {
    <div class="alert alert-info" role="alert">
      No products found. <a href="#" (click)="onAddNew()" class="alert-link">Add the first product</a>.
    </div>
  } @else {
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Description</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (product of products; track $index) {
            <tr>
              <td>{{ $index }}</td>
              <td>{{ product.name }}</td>
              <td>{{ product.description }}</td>
              <td>{{ product.price | currency }}</td>
              <td>{{ product.quantity }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary me-2" (click)="onEdit(product)">Edit</button>
                <button class="btn btn-sm btn-outline-danger" (click)="onDelete(product)">Delete</button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Modal -->
<div class="modal" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ isEdit ? 'Edit Product' : 'Add New Product' }}</h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        @if (formError) {
          <div class="alert alert-danger" role="alert">
            {{ formError }}
          </div>
        }
        <form [formGroup]="productForm" (ngSubmit)="onSubmit()">
          <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input id="name" type="text" class="form-control" formControlName="name" [class.is-invalid]="productForm.get('name')?.invalid && productForm.get('name')?.touched">
            @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
              <div class="invalid-feedback">Name is required.</div>
            }
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea id="description" class="form-control" rows="3" formControlName="description" [class.is-invalid]="productForm.get('description')?.invalid && productForm.get('description')?.touched"></textarea>
            @if (productForm.get('description')?.invalid && productForm.get('description')?.touched) {
              <div class="invalid-feedback">Description is required.</div>
            }
          </div>

          <div class="mb-3">
            <label for="price" class="form-label">Price</label>
            <input id="price" type="number" step="0.01" class="form-control" formControlName="price" [class.is-invalid]="productForm.get('price')?.invalid && productForm.get('price')?.touched">
            @if (productForm.get('price')?.invalid && productForm.get('price')?.touched) {
              <div class="invalid-feedback">Price is required and must be a positive number.</div>
            }
          </div>

          <div class="mb-3">
            <label for="quantity" class="form-label">Quantity</label>
            <input id="quantity" type="number" class="form-control" formControlName="quantity" [class.is-invalid]="productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched">
            @if (productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched) {
              <div class="invalid-feedback">Quantity is required and must be a non-negative integer.</div>
            }
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="productForm.invalid || formLoading">
          @if (formLoading) {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          }
          Save
        </button>
      </div>
    </div>
  </div>
</div>

@if (showModal) {
  <div class="modal-backdrop show"></div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal) {
  <div class="modal show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" (click)="cancelDelete()" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete the product <strong>{{ productToDelete?.name }}</strong>?</p>
          <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Cancel</button>
          <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deleteLoading">
            @if (deleteLoading) {
              <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            }
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-backdrop show"></div>
}